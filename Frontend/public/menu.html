<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu - MyRestaurant</title>
  <link rel="stylesheet" href="css/menu.css" />
  <style>
    /* Fixed checkout bar */
    .checkout-bar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      z-index: 999;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.2);
    }

    .checkout-btn {
      background: linear-gradient(135deg, #ffd369, #d4af37);
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      color: #000;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
    }

    .checkout-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(30%);
    }

    .cart-count {
      background: rgba(255, 255, 255, 0.08);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      display: inline-block;
    }

    /* small responsive tweak so grid doesn't hide behind bar */
    main.container {
      padding-bottom: 90px;
    }
  </style>
</head>

<body>

  <nav class="topnav">
    <div class="brand">üçΩÔ∏è MyRestaurant</div>
    <div class="links">
      <a href="dashboard.html">Home</a>
      <a href="menu.html" class="active">Menu</a>
      <a href="category.html">Category</a>
      <a href="cart.html">Checkout</a>
      <a href="orders.html">Your Orders</a>
      <a href="profile.html">Profile</a>
    </div>
  </nav>

  <main class="container">
    <h1 class="page-title">Our Menu</h1>
    <div id="menuGrid" class="menu-grid"></div>
  </main>

  <footer class="footer">
    ¬© 2025 MyRestaurant
  </footer>

  <!-- Checkout bar -->
  <div class="checkout-bar" id="checkoutBar" aria-live="polite">
    <div>
      Cart items: <span id="cartCount" class="cart-count">0</span>
    </div>
    <div>
      <button id="goCheckout" class="checkout-btn" disabled>Go to Checkout</button>
    </div>
  </div>

  <script>
    // improved imageMap (no duplicates)
    const imageMap = {
      "margherita pizza": "https://images.unsplash.com/photo-1574071318508-1cdbab80d002?q=80&w=869&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",
      "pepperoni pizza": "https://images.unsplash.com/photo-1594007654729-407eedc4be65?w=800",
      "bbq chicken pizza": "https://images.unsplash.com/photo-1655471264223-b07ce84d521c?q=80&w=511&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D",

      "caesar salad": "https://images.unsplash.com/photo-1551248429-40975aa4de74?w=800",
      "greek salad": "https://plus.unsplash.com/premium_photo-1690561082636-06237f98bfab?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8Z3JlZWslMjBzYWxhZHxlbnwwfHwwfHx8MA%3D%3D",

      "tomato basil soup": "https://images.unsplash.com/photo-1543353071-087092ec393a?w=800",
      "minestrone soup": "https://images.unsplash.com/photo-1551218808-94e220e084d2?w=800",

      "grilled salmon": "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=800",
      "steak frites": "https://images.unsplash.com/photo-1575900365671-6b67e2265d98?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8c3RlYWslMjBmcmlnaGp0c3xlbnwwfHwwfHx8MA%3D%3D",

      "spaghetti carbonara": "https://images.unsplash.com/photo-1633337474564-1d9478ca4e2e?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8U3BhZ2hldHRpJTIwQ2FyYm9uYXJhfGVufDB8fDB8fHww",
      "fettuccine alfredo": "https://images.unsplash.com/photo-1693609929945-b01ae4f2d602?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8M3x8RmV0dHVjY2luZSUyMEFsZnJlZG98ZW58MHx8MHx8fDA%3D",

      "chicken tacos": "https://plus.unsplash.com/premium_photo-1661755506463-625fea429dc8?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8Q2hpY2tlbiUyMFRhY29zfGVufDB8fDB8fHww",
      "beef burrito": "https://plus.unsplash.com/premium_photo-1664478294917-c11274b9ce79?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8QmVlZiUyMEJ1cnJpdG98ZW58MHx8MHx8fDA%3D",
      "veggie burrito": "https://plus.unsplash.com/premium_photo-1680118802557-2eb65574a5dc?w=500&auto=format&fit=crop&q=60&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8dmVnZ2llJTIwQnVycml0b3xlbnwwfHwwfHx8MA%3D%3D",

      "sushi platter": "https://images.unsplash.com/photo-1553621042-f6e147245754?w=800",
      "tempura": "https://images.unsplash.com/photo-1605792657660-596af9009e82?w=800",

      "chocolate brownie": "https://images.unsplash.com/photo-1600891964599-f61ba0e24092?w=800",
      "cheesecake": "https://images.unsplash.com/photo-1499636136210-6f4ee915583e?w=800",

      "mango smoothie": "https://images.unsplash.com/photo-1510626176961-4b57d4fbad03?w=800",
      "berry smoothie": "https://images.unsplash.com/photo-1497534446932-c925b458314e?w=800"
    };


    // Use logged in user id from localStorage if present
    const storedUserId = localStorage.getItem("userId");
    const USER_ID = storedUserId ? Number(storedUserId) : 1; // fallback to 1 for local testing

    // Read selected categoryId from URL
    const urlParams = new URLSearchParams(window.location.search);
    const selectedCategoryId = urlParams.get("categoryId");
    let apiURL = "http://localhost:5000/api/menu";

    async function loadMenu() {
      try {
        // Build API URL per category
        let fetchUrl = apiURL;
        if (selectedCategoryId) fetchUrl += `?categoryId=${encodeURIComponent(selectedCategoryId)}`;

        const res = await fetch(fetchUrl);
        if (!res.ok) throw new Error("Failed to load menu");
        const items = await res.json();

        const grid = document.getElementById("menuGrid");
        grid.innerHTML = "";

        if (items.length > 0 && selectedCategoryId) {
          document.querySelector(".page-title").innerHTML = `Menu ‚Äì ${items[0].CategoryName}`;
        }

        items.forEach(item => {
          const key = (item.Name || "").toLowerCase();
          const img = imageMap[key] || "https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?w=1200";

          const card = document.createElement("div");
          card.className = "menu-card";

          card.innerHTML = `
            <div class="img-wrap">
              <img src="${img}" alt="${escapeHtml(item.Name)}" loading="lazy"/>
            </div>
            <div class="menu-body">
              <h3 class="menu-title">${escapeHtml(item.Name)}</h3>
              <p class="menu-desc">${escapeHtml(item.Description || "")}</p>
              <div class="menu-footer">
                <span class="price">‚Çπ${Number(item.Price).toFixed(2)}</span>
                <button class="add-btn" data-id="${item.MenuItemID}">Add</button>
              </div>
            </div>
          `;

          grid.appendChild(card);
        });

        attachAddToCartEvents();
        // refresh cart count after loading menu (in case user already has items)
        await refreshCartCount();

      } catch (err) {
        console.error(err);
        document.getElementById("menuGrid").innerHTML = "<p class='error'>Could not load menu.</p>";
      }
    }

    function escapeHtml(unsafe = "") {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ============================================
    // ADD TO CART FUNCTIONALITY
    // ============================================
    function attachAddToCartEvents() {
      document.querySelectorAll(".add-btn").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = btn.dataset.id;
          btn.disabled = true;
          btn.textContent = "Adding...";
          try {
            await addToCart(id);
          } finally {
            btn.disabled = false;
            btn.textContent = "Add";
          }
        });
      });
    }

    async function addToCart(menuItemId) {
      try {
        const res = await fetch("http://localhost:5000/api/cart/add", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: USER_ID,
            menuItemId,
            quantity: 1
          })
        });

        const data = await res.json();
        if (!res.ok) {
          console.error("Add response:", data);
          showToast(data.message || "Failed to add to cart");
          return;
        }

        showToast(data.message || "Added to cart");
        await refreshCartCount();
      } catch (err) {
        console.error("Add to cart failed:", err);
        showToast("Error adding to cart");
      }
    }

    // ============================================
    // Cart count / checkout button control
    // ============================================
    async function refreshCartCount() {
      try {
        const res = await fetch(`http://localhost:5000/api/cart/${USER_ID}`);
        if (!res.ok) {
          console.error("Cart fetch failed", res.status);
          return;
        }
        const items = await res.json();
        const count = items.reduce((sum, it) => sum + Number(it.quantity || 0), 0);
        document.getElementById("cartCount").textContent = count;
        const goBtn = document.getElementById("goCheckout");
        if (count > 0) {
          goBtn.disabled = false;
        } else {
          goBtn.disabled = true;
        }
      } catch (err) {
        console.error("refreshCartCount error", err);
      }
    }

    // Go to cart.html when checkout pressed
    document.getElementById("goCheckout").addEventListener("click", () => {
      window.location.href = "cart.html";
    });

    // ============================================
    // TOAST MESSAGE
    // ============================================
    function showToast(msg) {
      let toast = document.createElement("div");
      toast.textContent = msg;
      toast.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        background: #1e90ff;
        color: white;
        padding: 12px 18px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        z-index: 9999;
        font-size: 15px;
        opacity: 1;
      `;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.transition = "opacity 0.3s";
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 350);
      }, 1400);
    }

    // initial load
    loadMenu();

    // refresh cart count periodically (optional) in case user updates cart elsewhere
    setInterval(() => refreshCartCount(), 8000);

  </script>

</body>

</html>